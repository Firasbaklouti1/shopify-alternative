### ==================================================
### Analytics Module API Tests
### ==================================================
### Token is obtained via login, not from env file

@host = http://localhost:8080

### ==================================================
### 0. AUTHENTICATION SETUP
### ==================================================
### 0.0 Register Merchant
POST {{host}}/api/v1/auth/register
Content-Type: application/json

{
  "storeName": "E2E Store {{$random.uuid}}",
  "storeSlug": "e2e-store-{{$random.uuid}}",
  "email": "merchant@example.com",
  "password": "password123",
  "fullName": "Merchant E2E"
}

> {%
    client.global.set("merchantEmail", response.body.ownerEmail || response.body.email);
    client.global.set("tenantId", response.body.id);
%}
### 0.1 Login as Merchant
# @name merchantLogin
POST {{host}}/api/v1/auth/login
Content-Type: application/json

{
  "email": "merchant@example.com",
  "password": "password123"
}

> {%
    client.global.set("merchantToken", response.body.token);
    client.log("âœ“ Logged in as merchant");
%}

###

### ==================================================
### 1. DASHBOARD STATS
### ==================================================

### 1.1 GET DASHBOARD STATS (Default - Last 30 Days)
GET {{host}}/api/v1/analytics/dashboard
Authorization: Bearer {{merchantToken}}

> {%
    client.test("Should return dashboard stats", function() {
        client.assert(response.status === 200, "Expected 200");
        client.assert(response.body.totalRevenue !== undefined, "Expected totalRevenue");
        client.assert(response.body.totalOrders !== undefined, "Expected totalOrders");
        client.assert(response.body.totalCustomers !== undefined, "Expected totalCustomers");
        client.assert(response.body.totalProducts !== undefined, "Expected totalProducts");
    });
    client.log("Dashboard Stats:");
    client.log("  Total Revenue: $" + response.body.totalRevenue);
    client.log("  Total Orders: " + response.body.totalOrders);
    client.log("  Total Customers: " + response.body.totalCustomers);
    client.log("  Total Products: " + response.body.totalProducts);
%}

###

### 1.2 GET DASHBOARD STATS FOR DATE RANGE
GET {{host}}/api/v1/analytics/dashboard/range?startDate=2026-01-01&endDate=2026-01-31
Authorization: Bearer {{merchantToken}}

> {%
    client.test("Should return dashboard stats for range", function() {
        client.assert(response.status === 200, "Expected 200");
        client.assert(Array.isArray(response.body.revenueChart), "Expected revenueChart array");
    });
%}

###

### 1.3 GET DASHBOARD STATS FOR LAST 7 DAYS
GET {{host}}/api/v1/analytics/dashboard/range?startDate=2026-01-13&endDate=2026-01-20
Authorization: Bearer {{merchantToken}}

> {%
    client.test("Should return 7-day dashboard stats", function() {
        client.assert(response.status === 200, "Expected 200");
    });
%}

###

### ==================================================
### 2. SALES REPORT
### ==================================================

### 2.1 GET SALES REPORT FOR JANUARY
GET {{host}}/api/v1/analytics/sales?startDate=2026-01-01&endDate=2026-01-31
Authorization: Bearer {{merchantToken}}

> {%
    client.test("Should return sales report", function() {
        client.assert(response.status === 200, "Expected 200");
        client.assert(response.body.periodStart !== undefined, "Expected periodStart");
        client.assert(response.body.periodEnd !== undefined, "Expected periodEnd");
        client.assert(response.body.totalRevenue !== undefined, "Expected totalRevenue");
        client.assert(response.body.totalOrders !== undefined, "Expected totalOrders");
        client.assert(response.body.averageOrderValue !== undefined, "Expected averageOrderValue");
    });
    client.log("Sales Report:");
    client.log("  Period: " + response.body.periodStart + " to " + response.body.periodEnd);
    client.log("  Total Revenue: $" + response.body.totalRevenue);
    client.log("  Total Orders: " + response.body.totalOrders);
    client.log("  Average Order Value: $" + response.body.averageOrderValue);
%}

###

### 2.2 GET SALES REPORT FOR LAST QUARTER
GET {{host}}/api/v1/analytics/sales?startDate=2025-10-01&endDate=2025-12-31
Authorization: Bearer {{merchantToken}}

> {%
    client.test("Should return quarterly sales report", function() {
        client.assert(response.status === 200, "Expected 200");
        client.assert(Array.isArray(response.body.salesByPeriod), "Expected salesByPeriod array");
    });
%}

###

### 2.3 GET SALES REPORT FOR SINGLE DAY
GET {{host}}/api/v1/analytics/sales?startDate=2026-01-15&endDate=2026-01-15
Authorization: Bearer {{merchantToken}}

> {%
    client.test("Should return single day sales report", function() {
        client.assert(response.status === 200, "Expected 200");
    });
%}

###

### ==================================================
### 3. CUSTOMER ANALYTICS
### ==================================================

### 3.1 GET CUSTOMER ANALYTICS (Default - Last 30 Days)
GET {{host}}/api/v1/analytics/customers
Authorization: Bearer {{merchantToken}}

> {%
    client.test("Should return customer analytics", function() {
        client.assert(response.status === 200, "Expected 200");
        client.assert(response.body.totalCustomers !== undefined, "Expected totalCustomers");
        client.assert(response.body.newCustomersThisPeriod !== undefined, "Expected newCustomersThisPeriod");
        client.assert(response.body.returningCustomers !== undefined, "Expected returningCustomers");
        client.assert(response.body.retentionRate !== undefined, "Expected retentionRate");
    });
    client.log("Customer Analytics:");
    client.log("  Total Customers: " + response.body.totalCustomers);
    client.log("  New This Period: " + response.body.newCustomersThisPeriod);
    client.log("  Returning: " + response.body.returningCustomers);
    client.log("  Retention Rate: " + response.body.retentionRate + "%");
%}

###

### 3.2 GET CUSTOMER ANALYTICS FOR DATE RANGE
GET {{host}}/api/v1/analytics/customers/range?startDate=2026-01-01&endDate=2026-01-31
Authorization: Bearer {{merchantToken}}

> {%
    client.test("Should return customer analytics for range", function() {
        client.assert(response.status === 200, "Expected 200");
        client.assert(Array.isArray(response.body.topCustomers), "Expected topCustomers array");
    });
%}

###

### 3.3 GET CUSTOMER ANALYTICS FOR LAST YEAR
GET {{host}}/api/v1/analytics/customers/range?startDate=2025-01-01&endDate=2025-12-31
Authorization: Bearer {{merchantToken}}

> {%
    client.test("Should return yearly customer analytics", function() {
        client.assert(response.status === 200, "Expected 200");
    });
%}

###

### ==================================================
### 4. AUTHORIZATION TESTS
### ==================================================

### 4.1 TRY WITHOUT TOKEN (should fail)
GET {{host}}/api/v1/analytics/dashboard

> {%
    client.test("Should fail without token", function() {
        client.assert(response.status === 401 || response.status === 403,
            "Expected 401/403 without token");
    });
%}

###

### ==================================================
### 5. EDGE CASES
### ==================================================

### 5.1 GET STATS FOR FUTURE DATE RANGE (should return zeros)
GET {{host}}/api/v1/analytics/dashboard/range?startDate=2027-01-01&endDate=2027-12-31
Authorization: Bearer {{merchantToken}}

> {%
    client.test("Future date range should return zeros", function() {
        client.assert(response.status === 200, "Expected 200");
        client.assert(response.body.totalOrders === 0, "Expected 0 orders for future dates");
    });
%}

###

### ==================================================
### 6. TOP CUSTOMERS CHECK
### ==================================================

### 6.1 VERIFY TOP CUSTOMERS SORTED BY SPEND
GET {{host}}/api/v1/analytics/customers
Authorization: Bearer {{merchantToken}}

> {%
    client.test("Top customers should be sorted by spend", function() {
        client.assert(response.status === 200, "Expected 200");
        var topCustomers = response.body.topCustomers;
        if (topCustomers && topCustomers.length > 1) {
            for (var i = 1; i < topCustomers.length; i++) {
                client.assert(
                    topCustomers[i-1].totalSpent >= topCustomers[i].totalSpent,
                    "Expected customers sorted by totalSpent descending"
                );
            }
        }
    });
%}
